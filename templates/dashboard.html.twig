{% extends "base.html.twig" %}

{% block title %}Dashboard - Ticket Management System{% endblock %}

{% block header %}
<header class="header">
    <div class="logo">TicketHub</div>
    <nav class="nav">
        <a href="/dashboard" class="nav-link">Dashboard</a>
        <a href="/tickets" class="nav-link">Tickets</a>
        <form action="/logout" method="post" style="display: inline;">
            <button type="submit" class="btn btn-secondary btn-sm">Logout</button>
        </form>
    </nav>
</header>
{% endblock %}

{% block content %}
<section class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Welcome back, {{ user.name }}!</h1>
        <a href="/tickets/create" class="btn btn-primary">Create New Ticket</a>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card total">
            <div class="stat-value">{{ stats.total }}</div>
            <div class="stat-label">Total Tickets</div>
        </div>
        
        <div class="stat-card open">
            <div class="stat-value">{{ stats.open }}</div>
            <div class="stat-label">Open Tickets</div>
        </div>
        
        <div class="stat-card in-progress">
            <div class="stat-value">{{ stats.in_progress }}</div>
            <div class="stat-label">In Progress</div>
        </div>
        
        <div class="stat-card closed">
            <div class="stat-value">{{ stats.closed }}</div>
            <div class="stat-label">Closed Tickets</div>
        </div>
    </div>
    
    <div class="grid grid-cols-2">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Quick Actions</h3>
            </div>
            <div class="card-body">
                <div class="d-flex flex-column gap-3">
                    <a href="/tickets/create" class="btn btn-primary">Create New Ticket</a>
                    <a href="/tickets" class="btn btn-outline">View All Tickets</a>
                    <a href="/reports" class="btn btn-outline">View Reports</a>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Recent Activity</h3>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>New ticket created</span>
                            <small class="text-muted">2 hours ago</small>
                        </div>
                    </li>
                    <li class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Ticket #3 marked as resolved</span>
                            <small class="text-muted">5 hours ago</small>
                        </div>
                    </li>
                    <li class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Ticket #2 status updated</span>
                            <small class="text-muted">1 day ago</small>
                        </div>
                    </li>
                    <li class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>New comment on Ticket #1</span>
                            <small class="text-muted">2 days ago</small>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header">
            <h3 class="card-title">Ticket Status Overview</h3>
        </div>
        <div class="card-body">
            <div class="progress mb-3" style="height: 25px;">
                {% if stats.total > 0 %}
                    {% set openPercent = (stats.open / stats.total) * 100 %}
                    {% set inProgressPercent = (stats.in_progress / stats.total) * 100 %}
                    {% set closedPercent = (stats.closed / stats.total) * 100 %}
                    
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ openPercent }}%;" aria-valuenow="{{ stats.open }}" aria-valuemin="0" aria-valuemax="{{ stats.total }}" title="Open: {{ stats.open }}">
                        {{ stats.open }}
                    </div>
                    <div class="progress-bar bg-warning" role="progressbar" style="width: {{ inProgressPercent }}%;" aria-valuenow="{{ stats.in_progress }}" aria-valuemin="0" aria-valuemax="{{ stats.total }}" title="In Progress: {{ stats.in_progress }}">
                        {{ stats.in_progress }}
                    </div>
                    <div class="progress-bar bg-secondary" role="progressbar" style="width: {{ closedPercent }}%;" aria-valuenow="{{ stats.closed }}" aria-valuemin="0" aria-valuemax="{{ stats.total }}" title="Closed: {{ stats.closed }}">
                        {{ stats.closed }}
                    </div>
                {% else %}
                    <div class="progress-bar" role="progressbar" style="width: 100%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        No tickets
                    </div>
                {% endif %}
            </div>
            <div class="d-flex justify-content-between">
                <div>
                    <span class="badge bg-success me-2">Open</span>
                    <span>{{ stats.open }} tickets</span>
                </div>
                <div>
                    <span class="badge bg-warning me-2">In Progress</span>
                    <span>{{ stats.in_progress }} tickets</span>
                </div>
                <div>
                    <span class="badge bg-secondary me-2">Closed</span>
                    <span>{{ stats.closed }} tickets</span>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block footer %}
<footer class="footer">
    <div class="footer-content">
        <p>&copy; 2023 TicketHub. All rights reserved.</p>
        <div class="footer-links">
            <a href="#privacy" class="nav-link">Privacy Policy</a>
            <a href="#terms" class="nav-link">Terms of Service</a>
            <a href="#contact" class="nav-link">Contact Us</a>
        </div>
    </div>
</footer>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Store session in localStorage for client-side checks
        storeSession({
            user_id: {{ user.user_id }},
            email: '{{ user.email }}',
            name: '{{ user.name }}'
        });
        
        // Check for any server-side messages and display as toast
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('success');
        const error = urlParams.get('error');
        
        if (success) {
            showToast(decodeURIComponent(success), 'success');
        }
        
        if (error) {
            showToast(decodeURIComponent(error), 'error');
        }
    });
</script>
{% endblock %}